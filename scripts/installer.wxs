<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
    
    <?define ProductName="GPU Temperature Monitor" ?>
    <?define ProductVersion="1.0.0.0" ?>
    <?define ProductManufacturer="GPU Monitor" ?>
    <?define UpgradeCode="12345678-1234-1234-1234-111111111111" ?>

    <Product Id="*" 
             Name="$(var.ProductName)" 
             Language="1033" 
             Version="$(var.ProductVersion)" 
             Manufacturer="$(var.ProductManufacturer)" 
             UpgradeCode="$(var.UpgradeCode)">
        
        <Package InstallerVersion="200" 
                 Compressed="yes" 
                 InstallScope="perMachine" 
                 Platform="x64"/>

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
        <MediaTemplate EmbedCab="yes"/>
        
        <!-- UI Configuration -->
        <UI>
            <TextStyle Id="Red" FaceName="Tahoma" Size="8" Red="255" Green="0" Blue="0"/>
            <UIRef Id="WixUI_Mondo"/>
            <UIRef Id="WixUI_ErrorProgressText"/>

            <!-- Custom ConfigDlg -->
            <Dialog Id="ConfigDlg" Width="370" Height="270" Title="!(loc.ConfigDlg_Title)">
                <!-- Header -->
                <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.ConfigDlgTitle)" />
                <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.ConfigDlgDescription)" />
                <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.ConfigDlgBannerBitmap)" />
                <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
                <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />

                <!-- Configuration Controls -->
                <Control Id="IntervalLabel" Type="Text" X="20" Y="60" Width="290" Height="13" Text="!(loc.ConfigDlgIntervalLabel)" />
                <Control Id="Interval" Type="Edit" X="20" Y="75" Width="50" Height="15" Property="POLLING_INTERVAL" />
                <Control Id="IntervalError" Type="Text" X="75" Y="75" Width="290" Height="13" Hidden="yes" Text="{\Red}!(loc.ConfigDlgIntervalError)" />

                <Control Id="ThresholdLabel" Type="Text" X="20" Y="100" Width="290" Height="13" Text="!(loc.ConfigDlgThresholdLabel)" />
                <Control Id="Threshold" Type="Edit" X="20" Y="115" Width="50" Height="15" Property="TEMPERATURE_THRESHOLD" />
                <Control Id="ThresholdError" Type="Text" X="75" Y="115" Width="290" Height="13" Hidden="yes" Text="{\Red}!(loc.ConfigDlgThresholdError)" />

                <!-- Navigation Buttons -->
                <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="!(loc.WixUIBack)" />
                <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Text="!(loc.WixUINext)" Default="yes">
                    <Condition Action="disable"><![CDATA[POLLING_INTERVAL < 1 OR POLLING_INTERVAL > 3600 OR TEMPERATURE_THRESHOLD < 0 OR TEMPERATURE_THRESHOLD > 110]]></Condition>
                    <Condition Action="enable"><![CDATA[POLLING_INTERVAL >= 1 AND POLLING_INTERVAL <= 3600 AND TEMPERATURE_THRESHOLD >= 0 AND TEMPERATURE_THRESHOLD <= 110]]></Condition>
                </Control>
                <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
                    <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
                </Control>
            </Dialog>

            <!-- Insert our dialog after InstallDirDlg -->
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ConfigDlg" Order="4">WIXUI_DONTVALIDATEPATH OR WIXUI_INSTALLDIR_VALID="1"</Publish>
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" Order="2">1</Publish>
            <Publish Dialog="ConfigDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg">1</Publish>
            <Publish Dialog="ConfigDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">
                <![CDATA[POLLING_INTERVAL >= 1 AND POLLING_INTERVAL <= 3600 AND TEMPERATURE_THRESHOLD >= 0 AND TEMPERATURE_THRESHOLD <= 110]]>
            </Publish>

            <!-- Validation Events -->
            <Publish Dialog="ConfigDlg" Control="Next" Event="Show" Value="IntervalError">
                <![CDATA[POLLING_INTERVAL < 1 OR POLLING_INTERVAL > 3600]]>
            </Publish>
            <Publish Dialog="ConfigDlg" Control="Next" Event="Hide" Value="IntervalError">
                <![CDATA[POLLING_INTERVAL >= 1 AND POLLING_INTERVAL <= 3600]]>
            </Publish>
            <Publish Dialog="ConfigDlg" Control="Next" Event="Show" Value="ThresholdError">
                <![CDATA[TEMPERATURE_THRESHOLD < 0 OR TEMPERATURE_THRESHOLD > 110]]>
            </Publish>
            <Publish Dialog="ConfigDlg" Control="Next" Event="Hide" Value="ThresholdError">
                <![CDATA[TEMPERATURE_THRESHOLD >= 0 AND TEMPERATURE_THRESHOLD <= 110]]>
            </Publish>

            <!-- Debug Dialog -->
            <Dialog Id="PythonDebugDlg" Width="370" Height="270" Title="Python Debug Info">
                <Control Id="OK" Type="PushButton" X="304" Y="243" Width="56" Height="17" Default="yes" Cancel="yes" Text="OK">
                    <Publish Event="EndDialog" Value="Return">1</Publish>
                </Control>
                <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="Python Installation Debug Info" />
                <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="The following Python installations were found:" />
                <Control Id="Store1Label" Type="Text" X="20" Y="50" Width="100" Height="13" Text="Store Path:" />
                <Control Id="Store1Value" Type="Text" X="120" Y="50" Width="230" Height="13" Text="[PYTHONSTORE_PATH]" />
                <Control Id="Store2Label" Type="Text" X="20" Y="70" Width="100" Height="13" Text="Store Path (Alt):" />
                <Control Id="Store2Value" Type="Text" X="120" Y="70" Width="230" Height="13" Text="[PYTHONSTORE_PATH_ALT]" />
                <Control Id="Python313Label" Type="Text" X="20" Y="90" Width="100" Height="13" Text="Python 3.13:" />
                <Control Id="Python313Value" Type="Text" X="120" Y="90" Width="230" Height="13" Text="[PYTHON313_REGKEY]" />
                <Control Id="Python312Label" Type="Text" X="20" Y="110" Width="100" Height="13" Text="Python 3.12:" />
                <Control Id="Python312Value" Type="Text" X="120" Y="110" Width="230" Height="13" Text="[PYTHON312_REGKEY]" />
                <Control Id="Python311Label" Type="Text" X="20" Y="130" Width="100" Height="13" Text="Python 3.11:" />
                <Control Id="Python311Value" Type="Text" X="120" Y="130" Width="230" Height="13" Text="[PYTHON311_REGKEY]" />
                <Control Id="FinalLabel" Type="Text" X="20" Y="170" Width="100" Height="13" Text="Selected Python:" />
                <Control Id="FinalValue" Type="Text" X="120" Y="170" Width="230" Height="13" Text="[PYTHON_PATH]" />
            </Dialog>

            <!-- Show debug dialog after welcome -->
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="PythonDebugDlg" Order="2">1</Publish>
            <Publish Dialog="PythonDebugDlg" Control="OK" Event="NewDialog" Value="LicenseAgreementDlg" Order="2">1</Publish>
        </UI>

        <!-- Properties for configuration -->
        <Property Id="GOTIFY_SERVER" Value="https://your-gotify-server" />
        <Property Id="GOTIFY_TOKEN" Value="your-gotify-token" />
        <Property Id="HIGH_TEMP" Value="80" />
        <Property Id="CRITICAL_TEMP" Value="90" />
        <Property Id="CHECK_INTERVAL" Value="60" />
        <Property Id="SHUTDOWN_DELAY" Value="300" />
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
        <Property Id="BannerBitmap" Value="WixUI_Bmp_Banner" />
        <Property Id="PYTHON_REGKEY" Secure="yes" />
        
        <Feature Id="ProductFeature" Title="GPU Temperature Monitor" Level="1">
            <ComponentRef Id="VenvFolderComponent"/>
            <ComponentRef Id="VenvDirComponent"/>
            <ComponentGroupRef Id="ProductComponents" />
            <ComponentGroupRef Id="ProgramMenuDir"/>
        </Feature>

        <!-- Windows Store Python: Search for the full path to python.exe -->
        <Property Id="PYTHONSTORE_PATH">
            <RegistrySearch Id="PythonStoreRegSearch"
                          Root="HKCU"
                          Key="Software\Python\PythonCore\3.13\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
        </Property>

        <!-- Additional search for Store Python -->
        <Property Id="PYTHONSTORE_PATH_ALT">
            <RegistrySearch Id="PythonStoreRegSearchAlt"
                          Root="HKCU"
                          Key="Software\Microsoft\Windows\CurrentVersion\App Paths\python.exe"
                          Type="raw"/>
        </Property>

        <!-- Traditional Python installations -->
        <Property Id="PYTHON313_REGKEY">
            <RegistrySearch Id="Python313RegSearch"
                          Root="HKLM"
                          Key="SOFTWARE\Python\PythonCore\3.13\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
            <RegistrySearch Id="Python313RegSearchUser"
                          Root="HKCU"
                          Key="SOFTWARE\Python\PythonCore\3.13\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
        </Property>
        <Property Id="PYTHON312_REGKEY">
            <RegistrySearch Id="Python312RegSearch"
                          Root="HKLM"
                          Key="SOFTWARE\Python\PythonCore\3.12\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
            <RegistrySearch Id="Python312RegSearchUser"
                          Root="HKCU"
                          Key="SOFTWARE\Python\PythonCore\3.12\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
        </Property>
        <Property Id="PYTHON311_REGKEY">
            <RegistrySearch Id="Python311RegSearch"
                          Root="HKLM"
                          Key="SOFTWARE\Python\PythonCore\3.11\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
            <RegistrySearch Id="Python311RegSearchUser"
                          Root="HKCU"
                          Key="SOFTWARE\Python\PythonCore\3.11\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
        </Property>
        <Property Id="PYTHON310_REGKEY">
            <RegistrySearch Id="Python310RegSearch"
                          Root="HKLM"
                          Key="SOFTWARE\Python\PythonCore\3.10\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
            <RegistrySearch Id="Python310RegSearchUser"
                          Root="HKCU"
                          Key="SOFTWARE\Python\PythonCore\3.10\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
        </Property>
        <Property Id="PYTHON39_REGKEY">
            <RegistrySearch Id="Python39RegSearch"
                          Root="HKLM"
                          Key="SOFTWARE\Python\PythonCore\3.9\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
            <RegistrySearch Id="Python39RegSearchUser"
                          Root="HKCU"
                          Key="SOFTWARE\Python\PythonCore\3.9\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
        </Property>
        <Property Id="PYTHON38_REGKEY">
            <RegistrySearch Id="Python38RegSearch"
                          Root="HKLM"
                          Key="SOFTWARE\Python\PythonCore\3.8\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
            <RegistrySearch Id="Python38RegSearchUser"
                          Root="HKCU"
                          Key="SOFTWARE\Python\PythonCore\3.8\InstallPath"
                          Name="ExecutablePath"
                          Type="raw"
                          Win64="yes"/>
        </Property>

        <!-- Additional search for Python in AppData Programs -->
        <Property Id="PYTHONAPPDATA_PATH">
            <DirectorySearch Id="PythonAppdataSearch" 
                            Path="[LocalAppDataFolder]\Programs\Python\Python313" 
                            Depth="1">
                <FileSearch Id="PythonExeAppdata" Name="python.exe"/>
            </DirectorySearch>
        </Property>

        <!-- Set PYTHON_PATH property for use in custom actions -->
        <Property Id="PYTHON_PATH" Secure="yes" />

        <!-- Set the Python path based on the first found version -->
        <SetProperty Id="PYTHON_PATH" Action="SetPythonPathAppdata" After="AppSearch" Value="[PYTHONAPPDATA_PATH]">
            PYTHONAPPDATA_PATH
        </SetProperty>
        <SetProperty Id="PYTHON_PATH" Action="SetPythonPathStore" After="SetPythonPathAppdata" Value="[PYTHONSTORE_PATH]">
            NOT PYTHONAPPDATA_PATH AND PYTHONSTORE_PATH
        </SetProperty>
        <SetProperty Id="PYTHON_PATH" Action="SetPythonPathStoreAlt" After="SetPythonPathStore" Value="[PYTHONSTORE_PATH_ALT]">
            NOT PYTHONAPPDATA_PATH AND NOT PYTHONSTORE_PATH AND PYTHONSTORE_PATH_ALT
        </SetProperty>
        <SetProperty Id="PYTHON_PATH" Action="SetPythonPath313" After="SetPythonPathStoreAlt" Value="[PYTHON313_REGKEY]">
            NOT PYTHONAPPDATA_PATH AND NOT PYTHONSTORE_PATH AND NOT PYTHONSTORE_PATH_ALT AND PYTHON313_REGKEY
        </SetProperty>

        <!-- Launch condition to ensure we have a Python path -->
        <Condition Message="This application requires Python 3.8 or higher. Please install Python 3.8 or higher and try again.">
            <![CDATA[Installed OR PYTHON_PATH]]>
        </Condition>

        <!-- Directory Structure -->
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="CommonAppDataFolder">
                <Directory Id="VENVFOLDER" Name="GPUTempMonitor">
                    <Component Id="VenvFolderComponent" Guid="12345678-1234-1234-1234-333333333333">
                        <CreateFolder Directory="VENVFOLDER">
                            <Permission User="Everyone" GenericAll="yes"/>
                        </CreateFolder>
                        <RemoveFolder Id="RemoveVenvFolder" On="uninstall" />
                    </Component>
                    <Directory Id="VENVDIR" Name="venv">
                        <Component Id="VenvDirComponent" Guid="12345678-1234-1234-1234-444444444444">
                            <CreateFolder>
                                <Permission User="Everyone" GenericAll="yes"/>
                            </CreateFolder>
                            <RemoveFolder Id="RemoveVenvDir" On="uninstall" />
                        </Component>
                    </Directory>
                </Directory>
            </Directory>
            <Directory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLFOLDER" Name="GPU Temperature Monitor">
                    <Directory Id="PSScriptsDir" Name="ps" />
                    <Directory Id="ConfigFolder" Name="config" />
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="GPU Temperature Monitor"/>
            </Directory>
            <Directory Id="SystemFolder"/>
        </Directory>

        <!-- Components -->
        <ComponentGroup Id="ProductComponents">
            <!-- PowerShell Scripts -->
            <Component Id="PowerShellScripts" Directory="PSScriptsDir" Win64="yes" Guid="12345678-1234-1234-1234-222222222222">
                <File Id="CreateVenvPS" 
                      Name="create_venv.ps1" 
                      Source="..\scripts\ps\create_venv.ps1" 
                      KeyPath="yes"/>
                <File Id="InstallReqPS" 
                      Name="install_requirements.ps1" 
                      Source="..\scripts\ps\install_requirements.ps1"/>
                <File Id="WriteConfigPS" 
                      Name="write_config.ps1" 
                      Source="..\scripts\ps\write_config.ps1"/>
                <File Id="LoggingPS" 
                      Name="logging.ps1" 
                      Source="..\scripts\ps\logging.ps1"/>
            </Component>

            <!-- Main Components -->
            <Component Id="MainExecutable" Directory="INSTALLFOLDER" Win64="yes" Guid="*">
                <File Id="MainPyFile" 
                      Name="gpu_monitor.py" 
                      Source="..\src\gpu_monitor.py" 
                      KeyPath="yes"/>
            </Component>

            <Component Id="Requirements" Directory="INSTALLFOLDER" Win64="yes" Guid="*">
                <File Id="RequirementsFile" 
                      Name="requirements.txt" 
                      Source="..\requirements.txt"
                      KeyPath="yes"/>
            </Component>

            <!-- Configuration -->
            <Component Id="ConfigurationFile" Directory="ConfigFolder" Win64="yes" Guid="*">
                <File Id="ConfigFile"
                      Name="config.ini"
                      Source="$(sys.CURRENTDIR)\config.ini"
                      KeyPath="yes"/>
                
                <!-- Remove config folder on uninstall -->
                <RemoveFile Id="RemoveConfigFile" Name="config.ini" On="uninstall" />
                <RemoveFolder Id="RemoveConfigFolder" On="uninstall" />
            </Component>

            <Component Id="ConfigurationRegistry" Directory="ConfigFolder" Win64="yes" Guid="*">
                <!-- Registry entries for service to locate config -->
                <RegistryKey Root="HKLM"
                           Key="SOFTWARE\GPU Temperature Monitor">
                    <RegistryValue Type="string" 
                                 Name="ConfigPath" 
                                 Value="[ConfigFolder]config.ini"
                                 KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <!-- Service Installation -->
            <Component Id="ServiceInstallation" Directory="INSTALLFOLDER" Win64="yes" Guid="*">
                <RegistryValue Root="HKLM"
                             Key="SOFTWARE\GPU Temperature Monitor"
                             Name="Service_Installed"
                             Type="integer"
                             Value="1"
                             KeyPath="yes"/>
                <ServiceInstall Id="ServiceInstaller"
                              Type="ownProcess"
                              Name="GPUTempMonitor"
                              DisplayName="GPU Temperature Monitor"
                              Description="Monitors GPU temperature and prevents overheating"
                              Start="auto"
                              Account="LocalSystem"
                              ErrorControl="normal"
                              Vital="yes">
                    <util:ServiceConfig 
                        FirstFailureActionType="restart"
                        SecondFailureActionType="restart"
                        ThirdFailureActionType="restart"
                        RestartServiceDelayInSeconds="60"/>
                </ServiceInstall>
                <ServiceControl Id="StartService" 
                              Start="install" 
                              Stop="both" 
                              Remove="uninstall" 
                              Name="GPUTempMonitor" 
                              Wait="yes" />
            </Component>

            <!-- Mock nvidia-smi installation -->
            <Component Id="MockNvidiaSmi" Directory="SystemFolder" Win64="no" Guid="*">
                <File Id="NvidiaSmi" 
                      Name="nvidia-smi.exe" 
                      Source="..\dist\nvidia-smi.exe" 
                      KeyPath="yes"/>
            </Component>
        </ComponentGroup>

        <!-- Start Menu Shortcuts -->
        <ComponentGroup Id="ProgramMenuDir" Directory="ApplicationProgramsFolder">
            <Component Id="ApplicationShortcuts" Win64="yes" Guid="*">
                <Shortcut Id="UninstallProduct"
                          Name="Uninstall GPU Monitor"
                          Description="Uninstalls GPU Temperature Monitor"
                          Target="[System64Folder]msiexec.exe"
                          Arguments="/x [ProductCode]"/>
                <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
                <RegistryValue Root="HKCU"
                             Key="Software\[Manufacturer]\[ProductName]"
                             Name="installed"
                             Type="integer"
                             Value="1"
                             KeyPath="yes"/>
            </Component>
        </ComponentGroup>

        <!-- Custom Actions -->
        <Property Id="POWERSHELL_PATH" Value="powershell.exe"/>
        
        <!-- Custom Actions -->
        <CustomAction Id="SetCreateVenvData" 
                     Property="CreateVenv" 
                     Value="&quot;[PYTHON_PATH]&quot; &quot;[VENVFOLDER]venv&quot;"
                     Execute="immediate"/>

        <CustomAction Id="SetInstallDepsData" 
                     Property="InstallDeps" 
                     Value="[VENVFOLDER]venv\Scripts\python.exe [INSTALLFOLDER]requirements.txt" 
                     Execute="immediate"/>

        <CustomAction Id="SetConfigData" 
                     Property="WriteConfig" 
                     Value="[ConfigFolder]config.ini [GOTIFY_TOKEN] [GOTIFY_SERVER_URL] [HIGH_TEMPERATURE_THRESHOLD] [CRITICAL_TEMPERATURE_THRESHOLD] [CHECK_INTERVAL_SECONDS] [EMERGENCY_SHUTDOWN_DURATION_SECONDS]" 
                     Execute="immediate"/>

        <CustomAction Id="LogPythonPaths"
                     Property="POWERSHELL_PATH"
                     ExeCommand='-NoProfile -ExecutionPolicy Bypass -File "[PSScriptsDir]logging.ps1" "Python paths - Store: [PYTHONSTORE_PATH], Store Alt: [PYTHONSTORE_PATH_ALT], 3.13: [PYTHON313_REGKEY], 3.12: [PYTHON312_REGKEY], 3.11: [PYTHON311_REGKEY], Selected: [PYTHON_PATH]"'
                     Execute="deferred"
                     Return="check"
                     Impersonate="no"/>

        <CustomAction Id="LogVenvCreation"
                     Property="POWERSHELL_PATH"
                     ExeCommand='-NoProfile -ExecutionPolicy Bypass -File "[PSScriptsDir]logging.ps1" "Creating virtual environment at [VENVFOLDER]venv using Python at [PYTHON_PATH]"'
                     Execute="deferred"
                     Return="check"
                     Impersonate="no"/>

        <CustomAction Id="CreateVenv" 
                     Property="POWERSHELL_PATH"
                     ExeCommand="-NoProfile -ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]ps\create_venv.ps1&quot; [CreateVenv]"
                     Execute="deferred"
                     Impersonate="no"
                     Return="check"/>

        <CustomAction Id="LogVenvCreationComplete"
                     Property="POWERSHELL_PATH"
                     ExeCommand='-NoProfile -ExecutionPolicy Bypass -File "[PSScriptsDir]logging.ps1" "Virtual environment creation completed"'
                     Execute="deferred"
                     Return="check"
                     Impersonate="no"/>

        <CustomAction Id="LogDepsInstallStart"
                     Property="POWERSHELL_PATH"
                     ExeCommand='-NoProfile -ExecutionPolicy Bypass -File "[PSScriptsDir]logging.ps1" "Starting dependencies installation"'
                     Execute="deferred"
                     Return="check"
                     Impersonate="no"/>

        <CustomAction Id="InstallDeps" 
                     Property="POWERSHELL_PATH"
                     ExeCommand='-NoProfile -ExecutionPolicy Bypass -File "[INSTALLFOLDER]ps\install_requirements.ps1" "[InstallDeps]"'
                     Execute="deferred"
                     Impersonate="no"
                     Return="check"/>

        <CustomAction Id="LogDepsInstallComplete"
                     Property="POWERSHELL_PATH"
                     ExeCommand='-NoProfile -ExecutionPolicy Bypass -File "[PSScriptsDir]logging.ps1" "Dependencies installation completed"'
                     Execute="deferred"
                     Return="check"
                     Impersonate="no"/>

        <CustomAction Id="WriteConfig" 
                     Property="POWERSHELL_PATH"
                     ExeCommand='-NoProfile -ExecutionPolicy Bypass -File "[PSScriptsDir]write_config.ps1" "[WriteConfig]"'
                     Execute="deferred"
                     Return="check"
                     Impersonate="no"/>

        <!-- Install Sequence -->
        <InstallExecuteSequence>
            <Custom Action="LogPythonPaths" Before="SetConfigData">NOT Installed</Custom>
            <Custom Action="SetCreateVenvData" Before="CreateVenv">NOT Installed</Custom>
            <Custom Action="LogVenvCreation" Before="CreateVenv">NOT Installed</Custom>
            <Custom Action="CreateVenv" After="InstallFiles">NOT Installed</Custom>
            <Custom Action="LogVenvCreationComplete" After="CreateVenv">NOT Installed</Custom>
            <Custom Action="SetInstallDepsData" Before="InstallDeps">NOT Installed</Custom>
            <Custom Action="LogDepsInstallStart" Before="InstallDeps">NOT Installed</Custom>
            <Custom Action="InstallDeps" After="CreateVenv">NOT Installed</Custom>
            <Custom Action="LogDepsInstallComplete" After="InstallDeps">NOT Installed</Custom>
            <Custom Action="SetConfigData" Before="WriteConfig">NOT Installed</Custom>
            <Custom Action="WriteConfig" After="InstallDeps">NOT Installed</Custom>
        </InstallExecuteSequence>

    </Product>
</Wix> 